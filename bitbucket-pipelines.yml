image: node:18

definitions:
  services:
    docker:
      memory: 2048

pipelines:
  default:
    - step:
        name: Build and Test
        script:
          - yarn --version
          - yarn install
          - yarn build
          - echo "âœ… Build successful!"

  branches:
    master:
      - step:
          name: Build and Deploy to Production
          deployment: production
          script:
            # Check yarn version
            - yarn --version
            
            # Install dependencies
            - yarn install
            
            # Build the project with environment variables from Bitbucket
            - echo "ğŸ”¨ Building project with environment variables..."
            - yarn build
            
            # Install SSH client and rsync for deployment
            - apt-get update && apt-get install -y openssh-client rsync
            
            # Configure SSH
            - mkdir -p ~/.ssh
            - echo "Host seojeek.com" >> ~/.ssh/config
            - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
            - echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
            - chmod 600 ~/.ssh/config
            
            # Deploy using rsync
            - echo "ğŸš€ Starting deployment..."
            
            # Create backup on server before deploying
            - |
              ssh alxvallejo@seojeek.com << 'ENDSSH'
              set -e
              echo "ğŸ“¦ Preparing deployment on server..."
              
              # Check if directory exists, create if needed
              if [ ! -d "/var/www/reddzit-refresh" ]; then
                echo "âš ï¸  Directory /var/www/reddzit-refresh doesn't exist"
                echo "Please create it manually with:"
                echo "  sudo mkdir -p /var/www/reddzit-refresh"
                echo "  sudo chown alxvallejo:alxvallejo /var/www/reddzit-refresh"
                exit 1
              fi
              
              cd /var/www/reddzit-refresh
              
              # Backup current version (without sudo)
              if [ -d "dist" ] && [ -w "." ]; then
                echo "ğŸ“¸ Creating backup of current version..."
                cp -r dist dist.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo "Could not create backup (permission issue)"
              fi
              
              echo "âœ… Server prepared for deployment"
              ENDSSH
            
            # Transfer the built dist folder to the server
            - echo "ğŸ“¤ Transferring built files to server..."
            - rsync -rltvz --delete --no-perms --no-owner --no-group dist/ alxvallejo@seojeek.com:/var/www/reddzit-refresh/dist/
            
            # Set permissions and reload nginx
            - |
              ssh alxvallejo@seojeek.com << 'ENDSSH'
              set -e
              cd /var/www/reddzit-refresh
              
              # Try to set permissions (will skip if no sudo access)
              echo "ğŸ”’ Setting permissions..."
              if sudo -n true 2>/dev/null; then
                sudo chown -R www-data:www-data dist/
                echo "âœ… Permissions set"
              else
                echo "âš ï¸  Cannot set permissions without sudo"
                echo "Run manually: sudo chown -R www-data:www-data /var/www/reddzit-refresh/dist/"
              fi
              
              # Try to reload nginx (will skip if no sudo access)
              echo "ğŸŒ Reloading nginx..."
              if sudo -n true 2>/dev/null; then
                sudo systemctl reload nginx
                echo "âœ… Nginx reloaded"
              else
                echo "âš ï¸  Cannot reload nginx without sudo"
                echo "Run manually: sudo systemctl reload nginx"
              fi
              
              # Validate deployment
              echo "âœ… Validating deployment..."
              curl -s -o /dev/null -w "%{http_code}" https://reddzit.seojeek.com | grep -q "200" && echo "âœ… Site is accessible!" || echo "âš ï¸ Site returned non-200 status"
              
              echo "ğŸ‰ Deployment complete!"
              ENDSSH
            
            - echo "âœ… Pipeline complete!"

    develop:
      - step:
          name: Build and Deploy to Staging
          deployment: staging
          script:
            - yarn --version
            - yarn install
            - yarn build
            - echo "âœ… Build successful for staging!"