image: node:18

definitions:
  services:
    docker:
      memory: 2048

pipelines:
  default:
    - step:
        name: Build and Test
        script:
          - yarn --version
          - yarn install
          - yarn build
          - echo "✅ Build successful!"

  branches:
    master:
      - step:
          name: Build and Deploy to Production
          deployment: production
          script:
            # Check yarn version
            - yarn --version
            
            # Install dependencies
            - yarn install
            
            # Build the project
            - yarn build
            
            # Install SSH client
            - apt-get update && apt-get install -y openssh-client
            
            # Configure SSH
            - mkdir -p ~/.ssh
            - echo "Host seojeek.com" >> ~/.ssh/config
            - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
            - echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
            - chmod 600 ~/.ssh/config
            
            # Deploy using direct SSH commands
            - echo "🚀 Starting deployment..."
            
            # Deploy to server (handling sudo issues)
            - |
              ssh alxvallejo@seojeek.com << 'ENDSSH'
              set -e
              echo "📦 Starting deployment on server..."
              
              # Check if directory exists, create if needed
              if [ ! -d "/var/www/reddzit-refresh" ]; then
                echo "⚠️  Directory /var/www/reddzit-refresh doesn't exist"
                echo "Please create it manually with:"
                echo "  sudo mkdir -p /var/www/reddzit-refresh"
                echo "  sudo chown alxvallejo:alxvallejo /var/www/reddzit-refresh"
                exit 1
              fi
              
              cd /var/www/reddzit-refresh
              
              # Backup current version (without sudo)
              if [ -d "dist" ] && [ -w "." ]; then
                echo "📸 Creating backup of current version..."
                cp -r dist dist.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo "Could not create backup (permission issue)"
              fi
              
              # Pull latest changes
              echo "📥 Pulling latest changes..."
              git pull origin master
              
              # Install dependencies
              echo "📦 Installing dependencies..."
              yarn install --frozen-lockfile
              
              # Build project
              echo "🔨 Building project..."
              yarn build
              
              # Try to set permissions (will skip if no sudo access)
              echo "🔒 Setting permissions..."
              if sudo -n true 2>/dev/null; then
                sudo chown -R www-data:www-data dist/
                echo "✅ Permissions set"
              else
                echo "⚠️  Cannot set permissions without sudo"
                echo "Run manually: sudo chown -R www-data:www-data /var/www/reddzit-refresh/dist/"
              fi
              
              # Try to reload nginx (will skip if no sudo access)
              echo "🌐 Reloading nginx..."
              if sudo -n true 2>/dev/null; then
                sudo systemctl reload nginx
                echo "✅ Nginx reloaded"
              else
                echo "⚠️  Cannot reload nginx without sudo"
                echo "Run manually: sudo systemctl reload nginx"
                # Try alternate method
                if [ -f /var/run/nginx.pid ]; then
                  kill -HUP $(cat /var/run/nginx.pid) 2>/dev/null || echo "Could not reload nginx"
                fi
              fi
              
              # Validate deployment
              echo "✅ Validating deployment..."
              curl -s -o /dev/null -w "%{http_code}" https://reddzit.seojeek.com | grep -q "200" && echo "✅ Site is accessible!" || echo "⚠️ Site returned non-200 status"
              
              echo "🎉 Deployment complete (manual steps may be required for permissions)"
              ENDSSH
            
            - echo "✅ Pipeline complete!"

    develop:
      - step:
          name: Build and Deploy to Staging
          deployment: staging
          script:
            - yarn --version
            - yarn install
            - yarn build
            - echo "✅ Build successful for staging!"